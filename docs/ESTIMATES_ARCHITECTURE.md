# Архитектура модуля Estimates (Сметы)

## Требования

1. **Сметы** - отдельная сущность, связанная с Workspace
2. **Файлы проекта** - неограниченное число файлов (ТЗ, PDF сметы, XLSX и т.д.)
3. **Разрешения на столбцы**:
   - Разные пользователи видят разные столбцы
   - Разные роли имеют разные права на создание/редактирование столбцов
   - Гибкая система доступа

## Варианты архитектуры

### Вариант 1: Разрешения на уровне столбца (рекомендуется)

**Модель ColumnPermission:**
```
ColumnPermission:
  - userId: String (ID пользователя)
  - columnId: String (ID столбца)
  - canView: Boolean (может видеть столбец)
  - canEdit: Boolean (может редактировать столбец)
  - canCreate: Boolean (может создавать столбцы - для будущего)
```

**Преимущества:**
- ✅ Гибкая система - можно настроить права для каждого пользователя на каждый столбец
- ✅ Масштабируемо - легко добавлять новые права
- ✅ Можно задавать права на уровне роли (через группу пользователей)

**Недостатки:**
- ❌ Много записей при большом количестве пользователей и столбцов
- ❌ Сложнее запросы (нужно проверять права при каждом обращении)

### Вариант 2: Разрешения на уровне роли + столбца

**Модель ColumnRolePermission:**
```
ColumnRolePermission:
  - role: Role (ADMIN, MANAGER, WORKER)
  - columnId: String (ID столбца)
  - canView: Boolean
  - canEdit: Boolean
```

**Преимущества:**
- ✅ Меньше записей (по ролям, а не по пользователям)
- ✅ Проще управление - права задаются на уровне роли

**Недостатки:**
- ❌ Менее гибко - нельзя задать права для конкретного пользователя
- ❌ Если нужны индивидуальные права - не подходит

### Вариант 3: Гибридный подход (рекомендуется для будущего)

**Комбинация:**
- Базовые права на уровне роли (ColumnRolePermission)
- Индивидуальные права для конкретных пользователей (ColumnPermission)
- При проверке: сначала проверяем индивидуальные права, если нет - берем права роли

**Преимущества:**
- ✅ Гибкость + простота управления
- ✅ Можно задать базовые права для роли, и переопределить для конкретных пользователей

## Рекомендация

**Для начала:** Вариант 2 (разрешения на уровне роли) - проще реализовать и управлять.

**Для будущего:** Перейти на Вариант 3 (гибридный) когда понадобятся индивидуальные права.

## Модель для файлов проекта

**WorkspaceFile:**
```
WorkspaceFile:
  - id: String
  - workspaceId: String (ID проекта)
  - name: String (название файла)
  - originalName: String (оригинальное имя файла)
  - mimeType: String (тип файла: application/pdf, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
  - filePath: String (путь к файлу на сервере или URL)
  - fileSize: Int (размер файла в байтах)
  - uploadedBy: String (ID пользователя, который загрузил)
  - description: String? (описание файла)
  - createdAt, updatedAt
```

## Итоговая архитектура (РЕАЛИЗОВАНО)

### Принятые решения:

1. **Разрешения на столбцы:** Вариант A (на уровне роли) - `ColumnRolePermission`
   - Права задаются для роли (ADMIN/MANAGER/WORKER) на каждый столбец
   - Поля: `canView`, `canEdit`, `canCreate`

2. **Файлы проекта:** Модель `WorkspaceFile`
   - Хранение: локально на сервере
   - Категории: поле `category` (ТЗ, Смета, Документы и т.д.)
   - Версионность: не реализована (можно добавить в будущем)

3. **Связи:**
   - ✅ Estimate → Workspace (один проект - много смет)
   - ✅ Estimate → User (createdBy - кто создал смету)
   - ✅ EstimateColumn → User (createdBy - кто создал столбец)
   - ✅ CellHistory → User (для аудита)
   - ✅ WorkspaceFile → User (uploadedBy - кто загрузил файл)

4. **Структура данных:**
   - ✅ `EstimateColumn.allowedValues` - JSON строка (например: `["м", "м2", "шт"]`)
   - ✅ `Cell.value` - String (парсим при необходимости для NUMBER)

### Модели в схеме:

1. **Estimate** - смета (ТЗ проекта)
2. **EstimateColumn** - столбец сметы (структура таблицы)
3. **EstimateRow** - строка сметы (позиция в смете)
4. **Cell** - ячейка таблицы (значение в пересечении строки и столбца)
5. **CellHistory** - история изменений ячейки (аудит)
6. **ColumnRolePermission** - разрешения на столбцы для ролей
7. **WorkspaceFile** - файлы проекта (ТЗ, сметы, документы)

