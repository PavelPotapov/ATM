# Настройка ngrok для доступа к приложению

## Обзор

Данная инструкция описывает настройку ngrok для предоставления внешнего доступа к локальному приложению.

## Быстрый старт

### Шаг 1: Настройка переменных окружения

**Backend:**
```bash
cd backend
copy .env.example .env
```

**Frontend:**
```bash
cd frontend
copy .env.example .env
```

**Можно оставить значения по умолчанию - они не критичны для production режима.**

### Шаг 2: Запуск в Production режиме

1. Запустите PostgreSQL: `docker-compose up -d`
2. Соберите и запустите: `pnpm run start:prod` (из корня проекта)
3. Запустите ngrok: `ngrok http 3000`
4. Готово! Используйте ngrok URL для доступа к приложению

**Важно:** Ngrok URL может меняться при перезапуске - ничего обновлять не нужно!

## Production режим

**Как работает:**

- ✅ Собрать фронтенд один раз: `pnpm run build:frontend`
- ✅ Бэкенд отдает фронтенд + API (все через один ngrok URL)
- ✅ Один ngrok туннель для всего приложения
- ✅ Проще для демонстрации - один URL для всего
- ✅ Ngrok URL может меняться - ничего обновлять не нужно (относительные пути)

**Преимущества:**
- ✅ Проще настройка - один ngrok URL
- ✅ Бэкенд отдает фронтенд автоматически
- ✅ Автоматическая работа с любым ngrok URL
- ✅ БД уже в Docker, менять не нужно
- ✅ Не нужно завертывать бэкенд в Docker

## Текущая архитектура

```
┌─────────────────┐
│   PostgreSQL     │  (Docker, порт 5432)
│   (Docker)       │
└─────────────────┘
         ▲
         │
┌─────────────────┐
│   Backend       │  (Локально, порт 3000)
│   (NestJS)      │
└─────────────────┘
         ▲
         │
┌─────────────────┐
│   Frontend      │  (Локально, порт 5173)
│   (Vite)        │
└─────────────────┘
```

## Шаги настройки

### 1. Установка ngrok

**Windows (через Chocolatey):**
```bash
choco install ngrok
```

**Или скачать с официального сайта:**
https://ngrok.com/download

**Или через npm (глобально):**
```bash
npm install -g ngrok
```

### 2. Регистрация и получение токена

1. Зарегистрируйтесь на https://ngrok.com
2. Получите токен авторизации в Dashboard
3. Авторизуйтесь:
   ```bash
   ngrok config add-authtoken YOUR_AUTH_TOKEN
   ```

### 3. Запуск ngrok для бэкенда

Запустите ngrok, пробросив порт 3000 (бэкенд):

```bash
ngrok http 3000
```

После запуска вы получите URL вида:
```
Forwarding: https://xxxx-xx-xx-xx-xx.ngrok-free.app -> http://localhost:3000
```

**Важно:** Сохраните этот URL (например, `https://xxxx-xx-xx-xx-xx.ngrok-free.app`)

### 4. Настройка бэкенда (CORS)

**Создайте `.env` файл в `backend/` на основе `.env.example`:**

```bash
cd backend
copy .env.example .env
```

**Для Production режима:**
```env
FRONTEND_URL=http://localhost:5173
# В production CORS разрешает все origins автоматически, это значение не критично
```

### 5. Настройка фронтенда (API URL)

**Создайте `.env` файл в `frontend/` на основе `.env.example`:**

```bash
cd frontend
copy .env.example .env
```

**Для Production режима:**

Фронтенд уже собран и встроен в бэкенд, настройка не требуется. Бэкенд автоматически отдает фронтенд и API через один ngrok URL.

**Важно:** 
- В production фронтенд использует относительные пути автоматически
- Ngrok URL может меняться - ничего обновлять не нужно!

### 6. Запуск приложения

**Терминал 1 - PostgreSQL (Docker):**
```bash
# Из корня проекта:
pnpm run docker:up
# Или вручную:
docker-compose up -d
```

**Терминал 2 - Build and start (production):**
```bash
# Из корня проекта - собирает фронтенд и бэкенд, затем запускает бэкенд:
pnpm run start:prod
```

**Терминал 3 - ngrok:**
```bash
ngrok http 3000
```

**Результат:** Один ngrok URL дает доступ и к фронтенду, и к API.

**Важно:** 
- Ngrok URL может меняться при перезапуске - ничего обновлять не нужно!
- Фронтенд использует относительные пути автоматически
- CORS разрешает все origins в production режиме

## Дополнительные варианты

### Вариант 2: Фронтенд через ngrok (не рекомендуется)

Если нужно предоставить доступ к фронтенду:

1. Запустите ngrok для фронтенда:
   ```bash
   ngrok http 5173
   ```

2. Обновите CORS на бэкенде, добавив ngrok URL фронтенда

3. Обновите `VITE_API_URL` на фронтенде на ngrok URL бэкенда

**Проблемы:**
- Медленнее разработка (нет HMR)
- Больше проблем с CORS
- Сложнее настройка

### Вариант 3: Оба через ngrok

Если нужно предоставить доступ и к фронтенду, и к бэкенду:

1. Запустите два ngrok туннеля:
   ```bash
   # Терминал 1
   ngrok http 3000
   
   # Терминал 2
   ngrok http 5173
   ```

2. Обновите CORS на бэкенде
3. Обновите `VITE_API_URL` на фронтенде

### Вариант 4: Бэкенд в Docker + ngrok

Если хотите завернуть бэкенд в Docker:

1. Создайте `Dockerfile` для бэкенда
2. Обновите `docker-compose.yml`
3. Запустите ngrok для Docker контейнера

**Не рекомендуется**, так как:
- Усложняет разработку
- Медленнее перезапуск
- Больше конфигурации

## Постоянный ngrok URL (платный план)

Если нужен постоянный URL (не меняется при перезапуске):

1. Перейдите на платный план ngrok
2. Зарезервируйте домен в Dashboard
3. Используйте зарезервированный домен:
   ```bash
   ngrok http 3000 --domain=your-reserved-domain.ngrok.app
   ```

## Безопасность

⚠️ **Важно:**
- ngrok URL публично доступен
- Не используйте в production без дополнительной защиты
- Рассмотрите использование ngrok с аутентификацией:
  ```bash
  ngrok http 3000 --basic-auth="username:password"
  ```

## Проверка работы

1. Откройте фронтенд: `http://localhost:5173`
2. Проверьте, что запросы идут на ngrok URL бэкенда
3. Проверьте Network tab в DevTools браузера

## Troubleshooting

### CORS ошибки

- Убедитесь, что `FRONTEND_URL` на бэкенде содержит правильный URL
- Проверьте, что фронтенд отправляет запросы на правильный `VITE_API_URL`

### ngrok URL меняется при перезапуске

- Это нормально для бесплатного плана
- Обновляйте `.env` файл фронтенда при каждом перезапуске ngrok
- Или используйте платный план с постоянным доменом

### Бэкенд не доступен через ngrok

- Убедитесь, что бэкенд запущен на порту 3000
- Проверьте, что ngrok запущен и указывает на порт 3000
- Проверьте логи ngrok

## Полезные ссылки

- [ngrok Documentation](https://ngrok.com/docs)
- [ngrok Dashboard](https://dashboard.ngrok.com)

